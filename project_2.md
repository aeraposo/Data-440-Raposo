## Project 2:<br/>

**Retrieving and subsetting DHS data**<br/>
- After writing a convincing proposal, I was granted acces to Uganda's DHS data. This data provides a comprehesive overview of the population of Uganda.<br/>
- In project 1, we generated De Facto settlement boundaries. De Facto settlements are generated by predictions of where individuals reside based on provided data and have proved to be fairly acurate representations of actual settlement locations and sizes. Polical boundaries, however, are politically established and are not necesarily representative of where people actually live- there are other influencing factors that affect where people actually congregate. Such factors are utilized in generating De Facto settlements.<br/>
- Within the survey, households fall within enumeration areas (analogous to census blocks) containing a given number of households and people residing in them for each area.<br/>
- Conducting surveys to collect the appropriate data is not only costly but also time consuming. Hence, generating a synthetic population is crucial for cost and time efficiency as it decreases the frequency in which re-surveying is required. This is largely due to the flexibility of the models we will create, which can account for changes in a population in the interim between data updates or recollection, allowing one to stay informed on growing demands for infrastructure.<br/>

```
# read in the data
uga_pop20 <- raster("/Users/aeraposo/uga_ppp_2020.tif")
uga_adm2 <- read_sf("/Users/aeraposo/Data-440-Raposo/project_1/gadm36_UGA_shp/gadm36_UGA_2.shp")

# DHS data
persons <- read.dta("UG_2016_DHS_09292020_1718_153327/UGIR7BDT/UGIR7BFL.DTA")
households <- read_dta("UG_2016_DHS_09292020_1718_153327/UGHR7BDT/UGHR7BFL.DTA")

# subset desired area
kumi <- uga_adm2 %>%
  filter(NAME_2 == 'Kumi')

# crop and mask the raster
kumi_pop20 <-crop(uga_pop20, kumi)
kumi_pop20 <-mask(kumi_pop20, kumi)

# get total population size
pop <- floor(cellStats(kumi_pop20,'sum'))

# find number of houses (divide total pop by average number of people per household)
houses <- pop/4.7

# subset households in kumi
kumi_sub <- subset(households, shdistrict == 208)
sum(households$hv005)
table(kumi_sub$hv009)

st_write(kumi, "kumi.shp", delete_dsn = TRUE)
kumi_mt <- readShapeSpatial("kumi.shp")
win <- as(kumi_mt,"owin")

# generate a ppp (planar point patter) of households in Kumi, Uganda
kumi_houses <- rpoint(houses, f = as.im(kumi_pop20),win = win)

# plot and save your ppp
png("kumi_ppp_house.png")
plot(win, main = NULL)
plot(kumi_houses, cex = 0.15)
dev.off()
```
*Kumi households:* Here is the ppp (planar point pattern) of household loactions in Kumi:<br/>
![kumi houses](https://aeraposo.github.io/Data-440-Raposo/houses_ppp.png)<br/>

*Confirmation of our projection:*<br/>
![plot 1](https://aeraposo.github.io/Data-440-Raposo/plot1prj2.png)

After some trial and error, I was able to produce a synthetic population and a more accurate plot of household distributions. The data read in above includes the locations of households, details about the residents of each household, and general qualities of the household (ie, household size).<br/>
Particularly, we used the information collected on individuals' wealth, education, age, sex, household size, and location to inform predictions about these qualities in the synthetic population. After extracting the above information from the household data gathered from a DTA file, I combined the respective columns into a new dataframe called hhs.<br/>

```
unit <- households$hv004
weights <- households$hv005 / 1000000
location <- as_factor(households$shdistrict)
size <- households$hv009
sex <- as_factor(households[ , 283:309])
age <- as_factor(households[ , 310:336])
education <- as_factor(households[ , 364:390])
wealth <- as_factor(households$hv270)
hhid <- as_factor(households$hhid)

# new dataframe
hhs <- cbind.data.frame(hhid,unit, weights, location, size, sex, age, education,wealth)
```
Next, I read in several shapefiles that contain geospatial infromation about the various levels of subdivisions within Uganda. The 0-level administrative subdivision (adm0) represents a detail on the scale of the entire country, the 1st level details the districts, and the 2nd level details smaller cities and counties. I also subset my adm2 by selecting pertinent data to the district of Kumi. I used this subset to crop and mask my population raster (a planar point pattern) to just view Kumi.<br/>

Next, using the floor function, I determined the total population by summing the values in my population raster. I then divided this value by the average household size, which gave me the total number of households.<br/>

```
uga_hhs_n <- floor(cellStats(uga_pop20, 'sum') / mean(hhs$size))
```

Next, I defined a window based on my adm0, which I used to define the scope of my plots. Using the number of households, I was then able to define the predicted planar locations of these houses based on information stored in the population raster within my defined window. This gave me geographic coordinates of the housholds, which I saved as the variable 'hhs_locs'.<br/>

```
st_write(uga_adm0, "uga0.shp", delete_dsn=TRUE)
uga0_mt <- readShapeSpatial("uga0.shp")
win <- as(uga0_mt, "owin")

hhs_pts <- rpoint(uga_hhs_n, f = as.im(uga_pop20), win = win)

pts <- cbind.data.frame(x = hhs_pts$x, y = hhs_pts$y)

hhs_locs = st_as_sf(pts, coords = c("x", "y"),
                    crs = st_crs(uga_adm0))
```

- The next task was to generate the households. I began the process by taking a slice (a sample) from the hhs dataframe. This slice contained 9,062,534 samples (sampling with replacement so we don't run out of data), which is the number we determined as the total number of house in Uganda. I then added an id column, which uniquely identifies each sample and joined the household locations with the samples taken based on corresponding id numbers. This step is crucial becuase without matching samples to the appropriate location, our population will be essentially random and will not likely resemble the actual population. The absolute weighted error of this sythetic population is 0 since all the observations in the slice are retrieved from the hhs data.<br/>

```
hhs_samp <- slice_sample(hhs, n = uga_hhs_n, replace = TRUE)[ ,c(2,4:86)]

hhs_locs$id <- 1:nrow(hhs_locs)
hhs_samp$id <- 1:nrow(hhs_samp)

uganda_joined <- left_join(hhs_locs, hhs_samp, by = c("id" = "id"))
```

Here is a plot of the distribution of samples across Uganda, taken above. <br/>

![plot 2](https://aeraposo.github.io/Data-440-Raposo/plot2prj2.png)<br/>

Next, to hone in on a smaller area of Uganda, I began working with data specific to Kumi.<br/>

```
kumi_hhs_n <- floor(cellStats(kumi_pop20, 'sum') / mean(subset(hhs, location == "kumi")$size))
```

I also saved the Kumi subset of the Adm2 data for easy access
```
st_write(kumi, "kumi.shp", delete_dsn=TRUE)
kumi_mt <- readShapeSpatial("kumi.shp")
win <- as(kumi_mt, "owin")
```

calculated error at the adm2 level: 0.0008717575
error after pivoting and generating people- 0.0156926
